<div class="container mt-5">

  <!-- Document extraction moved to aside -->
  <aside class="document-extraction mb-3" *ngIf="files.length > 0">
    <details>
      <summary>
        <h5>Extracted Documents</h5>
      </summary>
      <div class="card shadow-sm p-2">
        <ul class="nav nav-tabs nav-sm mb-2">
          <li class="nav-item" *ngFor="let doc of files; let i = index">
            <a class="nav-link py-1 px-2" [class.active]="i === selectedIndex" (click)="selectTab(i)">
              {{ doc.header.documentType | titlecase }}
            </a>
          </li>
        </ul>
        <div class="card-body p-2">
          <small><strong>Type:</strong> {{ files[selectedIndex].header.documentType }}</small>
          <span *ngIf="files[selectedIndex].header.dossierId">
            &nbsp;|&nbsp;<strong>Réf. Dossier:</strong> {{ files[selectedIndex].header.dossierId }}
          </span>
        </div>
        <!-- NAV TABS: show each documentType, call selectTab -->
        <ul class="nav nav-tabs nav-sm mb-2">
          <li class="nav-item" *ngFor="let f of files; let i = index">
            <a class="nav-link py-1 px-2" [class.active]="i === selectedIndex" (click)="selectTab(i)">
              {{ f.documentType | titlecase }}
            </a>
          </li>
        </ul>

      </div>
    </details>
  </aside>
  <div class="cnam-form position-relative">

    <div class="prescription-container">
      <!-- Pharmacy and Patient Info Header -->
      <div class="row mb-4">
        <!-- Modify the form-buttons and alert section -->
        <div class="row mb-3">
          <div class="col-12">
            <div class="form-buttons">
              <button type="button" class="btn btn-primary btn-sm" (click)="toggleEditMode()">
                <i class="bi bi-pencil-square me-1"></i>
                {{ isEditMode ? 'Save Changes' : 'Verify Data' }}
              </button>
            </div>

            <!-- Status Alert -->
            <div *ngIf="showStatusAlert" class="status-alert">
              <div class="alert py-2"
                [ngClass]="{'alert-warning': isEditMode, 'alert-success': !isEditMode && showStatusAlert}">
                <small *ngIf="isEditMode">Edit mode enabled. Please verify and correct any fields as needed.</small>
                <small *ngIf="!isEditMode && showStatusAlert">Changes saved successfully!</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Header -->

        <div class="col-md-6">
          <div class="pharmacy-info">
            <h3>
              <input type="text" class="form-control" [(ngModel)]="ordonnance.nom_pharmacie"
                placeholder="Nom de Pharmacie">
            </h3>
            <input type="text" class="form-control mb-2" [(ngModel)]="ordonnance.adresse_pharmacie"
              placeholder="Adresse">
            <input type="text" class="form-control mb-2" [(ngModel)]="ordonnance.telephone_fax"
              placeholder="Téléphone / Fax">
            <input type="text" class="form-control mb-2" [(ngModel)]="ordonnance.matricule_fiscale"
              placeholder="Matricule Fiscale">
          </div>
        </div>
        <div class="col-md-6">
          <div class="patient-info">
            <div class="info-group">
              <span class="info-label">ID Bénéficiaire:</span>
              <input type="text" class="form-control" [(ngModel)]="ordonnance.id_beneficiaire">
            </div>
            <div class="info-group">
              <span class="info-label">Identité du malade:</span>
              <input type="text" class="form-control" [(ngModel)]="ordonnance.nom_malade">
            </div>
            <div class="info-group">
              <span class="info-label">Code du prescripteur:</span>
              <input type="text" class="form-control" [(ngModel)]="ordonnance.code_prescripteur">
            </div>
            <div class="info-group">
              <span class="info-label">Date de la prescription:</span>
              <input type="date" class="form-control" [(ngModel)]="ordonnance.date_prescription">
            </div>
            <div class="info-group">
              <span class="info-label">Régime:</span>
              <input type="text" class="form-control" [(ngModel)]="ordonnance.regime">
            </div>
            <div class="info-group">
              <span class="info-label">Date de dispensation:</span>
              <input type="date" class="form-control" [(ngModel)]="ordonnance.date_dispensation">
            </div>
          </div>
        </div>
      </div>

      <!-- Title Box -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="title-box">
            Exécution d'une ordonnance
          </div>
        </div>
      </div>

      <!-- Executor Info -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="info-group">
            <span class="info-label">Exécuteur:</span>
            <input type="text" class="form-control" [(ngModel)]="ordonnance.code_executeur">
          </div>
        </div>
        <div class="col-md-6">
          <div class="info-group">
            <span class="info-label">Référence CNAM du pharmacien:</span>
            <input type="text" class="form-control" [(ngModel)]="ordonnance.reference_cnam">
          </div>
        </div>
      </div>

      <!-- Prescription Table -->
      <div class="row mb-4">
        <div class="col-12">
          <table class="prescription-table">
            <thead>
              <tr>
                <th>Code PCT</th>
                <th>Produit</th>
                <th>Forme</th>
                <th>Qte</th>
                <th>PUV</th>
                <th>Mt. Perçu</th>
                <th>N.I.O</th>
                <th>PR/Lot</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><input type="text" class="form-control" [(ngModel)]="ordonnance.code_pct"></td>
                <td><input type="text" class="form-control" [(ngModel)]="ordonnance.produit"></td>
                <td><input type="text" class="form-control" [(ngModel)]="ordonnance.forme"></td>
                <td>
                  <input type="number" class="form-control" [(ngModel)]="ordonnance.quantite"
                    (change)="calculateTotal()">
                </td>
                <td>
                  <input type="number" class="form-control" [(ngModel)]="ordonnance.prix_unitaire"
                    (change)="calculateTotal()">
                </td>
                <td>
                  <input type="number" class="form-control" [(ngModel)]="ordonnance.montant_percu">
                </td>
                <td><input type="text" class="form-control" [(ngModel)]="ordonnance.nio"></td>
                <td><input type="text" class="form-control" [(ngModel)]="ordonnance.pr_lot"></td>
              </tr>
              <tr class="total-row">
                <td colspan="5" class="text-end">Total</td>
                <td>
                  <input type="number" class="form-control" [(ngModel)]="ordonnance.montant_total">
                </td>
                <td colspan="2"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Total Amount in Words -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="info-group">
            <span class="info-label">Arrêtée à la somme de:</span>
            <input type="text" class="form-control" [(ngModel)]="ordonnance.montant_en_lettres"
              placeholder="Montant en lettres">
          </div>
        </div>
      </div>

      <!-- Thank You Message -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="thank-you-message">
            &lt;&lt; Merci et bon rétablissement &gt;&gt;
          </div>
        </div>
      </div>

      <!-- Footer with Pharmacy Info -->
      <div class="row mb-5">
        <div class="col-md-4">
          <div class="pharmacy-stamp">
            <p>{{ ordonnance.nom_pharmacie || 'Nom de Pharmacie' }}</p>
            <p>{{ ordonnance.adresse_pharmacie || 'Adresse' }}</p>
            <p>{{ ordonnance.telephone_fax || 'Tél / Fax' }}</p>
            <p>{{ ordonnance.matricule_fiscale || 'Matricule Fisc.' }}</p>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->

    </div>
  </div>