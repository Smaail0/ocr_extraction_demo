<ng-container *ngIf="prescription">
  <div class="container mt-5">
    <div class="cnam-form position-relative">
      <div class="prescription-container">
        <!-- Form Buttons / Alert -->
        <div class="row mb-3">
          <div class="col-12">
            <div class="form-buttons">
              <button
                type="button"
                class="btn btn-primary btn-sm"
                (click)="toggleEditMode()"
              >
                <i class="bi bi-pencil-square me-1"></i>
                {{ isEditMode ? "Save Changes" : "Verify Data" }}
              </button>
            </div>
            <div *ngIf="showStatusAlert" class="status-alert">
              <div
                class="alert py-2"
                [ngClass]="{
                  'alert-warning': isEditMode,
                  'alert-success': !isEditMode
                }"
              >
                <small *ngIf="isEditMode">
                  Edit mode enabled. Please verify and correct any fields as
                  needed.
                </small>
                <small *ngIf="!isEditMode"> Changes saved successfully! </small>
              </div>
            </div>
          </div>
        </div>

        <!-- Pharmacy Info -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="pharmacy-info">
              <h3>
                <span class="info-label">Nom du Pharmacie: </span>
                <input
                  type="text"
                  class="form-control"
                  [(ngModel)]="prescription.pharmacyName"
                  [readonly]="!isEditMode"
                  placeholder="Nom de Pharmacie"
                />
              </h3>
              <h3>
                <span class="info-label">Adresse: </span>
                <input
                  type="text"
                  class="form-control mb-2"
                  [(ngModel)]="prescription.pharmacyAddress"
                  [readonly]="!isEditMode"
                  placeholder="Adresse de Pharmacie"
                />
              </h3>
              <h3>
                <span class="info-label">Contact Tél / Fax: </span>
                <input
                  type="text"
                  class="form-control mb-2"
                  [(ngModel)]="prescription.pharmacyContact"
                  [readonly]="!isEditMode"
                  placeholder="Tel/Fax"
                />
              </h3>
              <h3>
                <span class="info-label">Matricule Fiscale: </span>
                <input
                  type="text"
                  class="form-control mb-2"
                  [(ngModel)]="prescription.pharmacyFiscalId"
                  [readonly]="!isEditMode"
                  placeholder="Matricule Fiscale"
                />
              </h3>
            </div>
          </div>

          <!-- Patient Info -->
          <div class="col-md-6">
            <div class="patient-info">
              <div class="info-group mb-2">
                <span class="info-label">ID Bénéficiaire:</span>
                <input
                  type="text"
                  class="form-control"
                  [(ngModel)]="prescription.beneficiaryId"
                  [readonly]="!isEditMode"
                />
              </div>
              <div class="info-group mb-2">
                <span class="info-label">Identité du malade:</span>
                <input
                  type="text"
                  class="form-control"
                  [(ngModel)]="prescription.patientIdentity"
                  [readonly]="!isEditMode"
                />
              </div>
              <div class="info-group mb-2">
                <span class="info-label">Code du prescripteur:</span>
                <input
                  type="text"
                  class="form-control"
                  [(ngModel)]="prescription.prescriberCode"
                  [readonly]="!isEditMode"
                />
              </div>
              <div class="info-group mb-2">
                <span class="info-label">Date de la prescription:</span>
                <input
                  type="date"
                  class="form-control"
                  [(ngModel)]="prescription.prescriptionDate"
                  [readonly]="!isEditMode"
                />
              </div>
              <div class="info-group mb-2">
                <span class="info-label">Régime:</span>
                <input
                  type="text"
                  class="form-control"
                  [(ngModel)]="prescription.regimen"
                  [readonly]="!isEditMode"
                />
              </div>
              <div class="info-group">
                <span class="info-label">Date de dispensation:</span>
                <input
                  type="date"
                  class="form-control"
                  [(ngModel)]="prescription.dispensationDate"
                  [readonly]="!isEditMode"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Executor Info -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="info-group">
              <span class="info-label">Exécuteur:</span>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="prescription.executor"
                [readonly]="!isEditMode"
              />
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-group">
              <span class="info-label">Référence CNAM du pharmacien:</span>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="prescription.pharmacistCnamRef"
                [readonly]="!isEditMode"
              />
            </div>
          </div>
        </div>

        <!-- Prescription Table -->
        <div class="row mb-4">
          <div class="col-12">
            <table class="prescription-table">
              <thead>
                <tr>
                  <th>Code PCT</th>
                  <th>Produit</th>
                  <th>Forme</th>
                  <th>Qte</th>
                  <th>PUV</th>
                  <th>Mt. Perçu</th>
                  <th>N.I.O</th>
                  <th>PR/Lot</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of prescription.items; let i = index">
                  <td>
                    <input
                      type="text"
                      class="form-control"
                      [(ngModel)]="item.codePCT"
                      [readonly]="!isEditMode"
                      name="codePCT{{ i }}"
                    />
                  </td>
                  <td>
                    <input
                      type="text"
                      class="form-control"
                      [(ngModel)]="item.produit"
                      [readonly]="!isEditMode"
                      name="produit{{ i }}"
                    />
                  </td>
                  <td>
                    <input
                      type="text"
                      class="form-control"
                      [(ngModel)]="item.forme"
                      [readonly]="!isEditMode"
                      name="forme{{ i }}"
                    />
                  </td>
                  <td>
                    <input
                      type="text"
                      class="form-control"
                      [(ngModel)]="item.qte"
                      [readonly]="!isEditMode"
                      name="qte{{ i }}"
                    />
                  </td>
                  <td>
                    <input
                      type="text"
                      class="form-control"
                      [(ngModel)]="item.puv"
                      [readonly]="!isEditMode"
                      name="puv{{ i }}"
                    />
                  </td>
                  <td>
                    <input
                      type="text"
                      class="form-control"
                      [(ngModel)]="item.montantPercu"
                      name="montantPercu{{ i }}"
                      [readonly]="!isEditMode"
                      (ngModelChange)="calculateTotals()"
                    />
                  </td>
                  <td>
                    <input
                      type="text"
                      class="form-control"
                      [(ngModel)]="item.nio"
                      [readonly]="!isEditMode"
                      name="nio{{ i }}"
                    />
                  </td>
                  <td>
                    <input
                      type="text"
                      class="form-control"
                      [(ngModel)]="item.prLot"
                      [readonly]="!isEditMode"
                      name="prLot{{ i }}"
                    />
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr class="summary-row">
                  <!-- empty cells for Code→Qte -->
                  <td colspan="4"></td>
                  <!-- PUV column: Total TTC -->
                  <td class="text-center">
                    <strong>{{ prescription.total }}</strong>
                  </td>
                  <!-- Mt. Perçu col -->
                  <td class="text-center">
                    <strong>Ml perçu : {{ prescription.mtPercu }}</strong>
                  </td>
                  <!-- N.I.O col -->
                  <td class="text-center">
                    <strong>Mt Restant : {{ prescription.mtRes }}</strong>
                  </td>
                  <!-- PR/Lot col empty -->
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Total in Words -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="info-group">
              <span class="info-label">Arrêtée à la somme de:</span>
              <textarea
                class="form-control"
                rows="2"
                [(ngModel)]="prescription.totalInWords"
                [readonly]="!isEditMode"
                name="totalInWords"
                placeholder="Montant en lettres"
              ></textarea>
            </div>
          </div>
        </div>

        <div
          *ngIf="!signatureResult && signatureUrl"
          class="alert alert-warning"
        >
          <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
          La découpe de la signature n’est pas toujours fiable à 100 % :
          merci de vérifier avant de lancer l’analyse.
        </div>

        <!-- Signature -->
        <div *ngIf="signatureUrl" class="signature-container">
          <label class="signature-label">Signature du médecin :</label>
          <img
            [src]="signatureUrl"
            alt="Signature du médecin"
            class="signature-img"
          />

          <!-- Hint when no ID yet -->
          <div
            *ngIf="!prescription.id"
            class="text-muted small mb-2 d-flex align-items-center"
          >
            <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
            Vérifiez et enregistrez d’abord avant d’analyser.
          </div>

          <div class="signature-check">
            <button
              class="btn btn-primary btn-sm"
              (click)="analyseSignature()"
              [disabled]="signatureLoading || !prescription.id"
            >
              {{ signatureLoading ? "Vérification…" : "Vérifier la signature" }}
            </button>
          </div>
        </div>

        <!-- results -->
        <div *ngIf="signatureResult" class="signature-result mt-3">
          <p>AKAZE score: {{ signatureResult.akaze | number : "1.2-2" }}</p>
          <p>SSIM score: {{ signatureResult.ssim | number : "1.2-2" }}</p>
          <p>
            Signature authentique?
            <strong
              [ngClass]="
                signatureResult.genuine ? 'text-success' : 'text-danger'
              "
            >
              {{ signatureResult.genuine ? "Oui" : "Non" }}
            </strong>
          </p>
        </div>
      </div>

      <!-- Footer Stamp -->
      <div class="row mb-5">
        <div class="col-md-4 pharmacy-stamp">
          <p>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="prescription.pharmacyName"
              [readonly]="!isEditMode"
              placeholder="Nom de Pharmacie"
            />
          </p>
          <p>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="prescription.pharmacyAddress"
              [readonly]="!isEditMode"
              placeholder="Adresse de Pharmacie"
            />
          </p>
          <p>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="prescription.pharmacyContact"
              [readonly]="!isEditMode"
              placeholder="Tél/Fax"
            />
          </p>
          <p>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="prescription.pharmacyFiscalId"
              [readonly]="!isEditMode"
              placeholder="Matricule Fiscale"
            />
          </p>
        </div>
      </div>
    </div>
  </div>
</ng-container>
